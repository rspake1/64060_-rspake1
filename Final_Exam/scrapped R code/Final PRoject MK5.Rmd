---
title: "Final Project MK5"
author: "Ryan Spake"
date: "12/11/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Pull Credit Card data from Taiwan April 2005 - September 2005

The data below comes from UCI Machine Learning on Kaggle.(https://www.kaggle.com/uciml/default-of-credit-card-clients-dataset)
There are 25 variables:

**CONTENT**
ID: ID of each client
LIMIT_BAL: Amount of given credit in NT dollars (includes individual and family/supplementary credit
SEX: Gender (1=male, 2=female)
EDUCATION: **(1=graduate school, 2=university, 3=high school, 4=others, 5=unknown, 6=unknown)**
MARRIAGE: Marital status (1=married, 2=single, 3=others)
AGE: Age in years
PAY_0: Repayment status in September, 2005 **(-1=pay duly, 1=payment delay for one month, 2=payment delay for two months, â€¦ 8=payment delay for eight months, 9=payment delay for nine months and above)**
PAY_2: Repayment status in August, 2005 (scale same as above)
PAY_3: Repayment status in July, 2005 (scale same as above)
PAY_4: Repayment status in June, 2005 (scale same as above)
PAY_5: Repayment status in May, 2005 (scale same as above)
PAY_6: Repayment status in April, 2005 (scale same as above)
BILL_AMT1: Amount of bill statement in September, 2005 (NT dollar)
BILL_AMT2: Amount of bill statement in August, 2005 (NT dollar)
BILL_AMT3: Amount of bill statement in July, 2005 (NT dollar)
BILL_AMT4: Amount of bill statement in June, 2005 (NT dollar)
BILL_AMT5: Amount of bill statement in May, 2005 (NT dollar)
BILL_AMT6: Amount of bill statement in April, 2005 (NT dollar)
PAY_AMT1: Amount of previous payment in September, 2005 (NT dollar)
PAY_AMT2: Amount of previous payment in August, 2005 (NT dollar)
PAY_AMT3: Amount of previous payment in July, 2005 (NT dollar)
PAY_AMT4: Amount of previous payment in June, 2005 (NT dollar)
PAY_AMT5: Amount of previous payment in May, 2005 (NT dollar)
PAY_AMT6: Amount of previous payment in April, 2005 (NT dollar)
default.payment.next.month: Default payment **(1=yes, 0=no)**


The code below prepares the data and created a dummy variable for education which seperates it into it's seperate parts.

```{r cars}

library(caret)
library(class)
library(dplyr)
library(gmodels)
library(knitr)
library(rmarkdown)
Original <- read.csv("C:\\Users\\rspake1\\Desktop\\UCI_Credit_Card.csv")
DF_CC <- Original %>% select(LIMIT_BAL, SEX, EDUCATION, MARRIAGE, AGE, PAY_0, PAY_2, PAY_3, PAY_4, PAY_5, PAY_6, BILL_AMT1, BILL_AMT2, BILL_AMT3, BILL_AMT4, BILL_AMT5, BILL_AMT6, PAY_AMT1, PAY_AMT2, PAY_AMT3, PAY_AMT4, PAY_AMT5, PAY_AMT6, default.payment.next.month)
DF_CC$EDUCATION <- as.factor(DF_CC$EDUCATION)
DF_CC$default.payment.next.month <- as.factor((DF_CC$default.payment.next.month))
EDUCATION <- dummyVars(~EDUCATION,DF_CC)
EduDV <- predict(EDUCATION, DF_CC)
DF_CC <- subset(DF_CC, select = -c(EDUCATION))
dvDF_CC <- cbind(DF_CC,EduDV)
set.seed(170)
```

## Train index

Below we partition the data to be trained. 

The most important step is we move the default column to the end of the dataframe (now [,30] instead of [,23]).

```{r pressure}
Train_Index = createDataPartition(dvDF_CC$default.payment.next.month, p=0.70, list=FALSE)
Train_Data = dvDF_CC[Train_Index,]

Extra_Data = dvDF_CC[-Train_Index,]
Validation_Index = createDataPartition(Extra_Data$default.payment.next.month, p=0.40, list = FALSE)
Validation_Data = Extra_Data[Validation_Index,]
Test_Data = Extra_Data[-Validation_Index,]



```

## Normalize

We then normalize the data via Z score.
```{r}
train.norm.df <- Train_Data
valid.norm.df <- Validation_Data
test.norm.df <- Test_Data
dvCC.norm.df <- dvDF_CC
norm.model <- preProcess(Train_Data, method = c("center", "scale"))
train.norm.df <- predict(norm.model, Train_Data)

valid.norm.df <- predict(norm.model, Validation_Data)

test.norm.df <- predict(norm.model, Test_Data)
```




```{r}
Train_Predictors <- train.norm.df[,1:29]
Test_Predictors <- test.norm.df[,1:29]
Valid_Predictors <- valid.norm.df[,1:29]
Train_Labels <- train.norm.df[,30]
Test_Labels <- test.norm.df[,30]
Valid_Labels <- valid.norm.df[,30]
```


```{r}
Search_grid <- expand.grid(k=c(1,2))
model_1 <- train(default.payment.next.month~LIMIT_BAL+SEX+MARRIAGE+AGE+PAY_0+PAY_2+PAY_3+BILL_AMT1+BILL_AMT2+BILL_AMT3+PAY_AMT1+PAY_AMT2+PAY_AMT3+EDUCATION.0+EDUCATION.1+EDUCATION.2+EDUCATION.3+EDUCATION.4+EDUCATION.5+EDUCATION.6, data = Train_Data, drop = FALSE, method="knn", tuneGrid=Search_grid)
model_1
```


```{r}
Predicted_Valid_labels <- knn(Train_Predictors,Valid_Predictors,cl=Train_Labels,k=1, prob = TRUE)
head(Predicted_Valid_labels)
class_prob <- attr(Predicted_Valid_labels,'prob')
head(class_prob)

Predicted_Train_labels <- knn(Train_Predictors,Train_Predictors,cl=Train_Labels,k=1, prob = TRUE)
head(Predicted_Valid_labels)
class_prob <- attr(Predicted_Valid_labels,'prob')
head(class_prob)

Predicted_Test_labels <- knn(Train_Predictors,Test_Predictors,cl=Train_Labels,k=1, prob = TRUE)
head(Predicted_Test_labels)
class_prob <- attr(Predicted_Test_labels,'prob')
head(class_prob)

CrossTable(x=Valid_Labels,y=Predicted_Valid_labels,prop.chisq = FALSE)
CrossTable(x=Train_Labels,y=Predicted_Train_labels,prop.chisq = FALSE)
CrossTable(x=Test_Labels,y=Predicted_Test_labels,prop.chisq = FALSE)
```



```{r}


```











Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
